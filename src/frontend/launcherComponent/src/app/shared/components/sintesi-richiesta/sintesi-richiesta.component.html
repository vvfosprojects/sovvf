<div class="py-2 px-3"
     style="max-height: 297px; overflow-y: auto"
     [class.border-top-richiesta]="borderTop"
     [class.text-moon]="nightMode"
     [class.moon-card-light]="nightMode"
     (click)="richiestaClick(richiesta)"
     (mouseenter)="richiestaHoverIn(richiesta)"
     (mouseleave)="richiestaHoverOut(richiesta)">
    <div class="row align-items-center">
        <div class="col-12">
            <div class="row">
                <div class="col-md-12">
                    <!-- Icona Richiesta Sospesa -->
                    <div *ngIf="richiesta?.stato === StatoRichiesta.Sospesa"
                         [ngStyle]="{'left':  richiesta?.esercitazione ? '25px' : '20px' }"
                         class="d-inline-block text-danger font-weight-bolder h4"
                         style="position: absolute; top:22px">
                        S
                    </div>
                    <!-- Icona Richiesta Esercitazione -->
                    <div *ngIf="richiesta?.esercitazione"
                         class="d-inline-block text-primary font-weight-bolder h4"
                         style="position: absolute; left: 5px; top:22px">
                        E
                    </div>
                    <!-- PRIMA RIGA -->
                    <div class="row">
                        <!-- Priorità -->
                        <div class="clearfix ml-4" style="width: 2%">
                            <ng-container *ngIf="richiesta.stato === StatoRichiesta.Chiamata">
                                <i class="guida fas fa-thermometer-half fa-fw  d-none"
                                   [class.high-priority]="richiesta.prioritaRichiesta > 3"
                                   ngbTooltip="Priorità della richiesta" placement="right"></i>
                                <ngb-rating [(rate)]="richiesta.prioritaRichiesta"
                                            [max]="4"
                                            [readonly]="true"
                                            style="position: absolute; display: inline-grid !important; font: small-caption; transform: rotate(180deg)">
                                    <ng-template let-fill="fill" let-index="index">
                                            <span class="circle "
                                                  [class.filled]="fill === 100"
                                                  [class.bad]="index > 2 && fill === 100">
                                                <i class="fas fa-circle mr-1"></i>
                                            </span>
                                    </ng-template>
                                </ngb-rating>
                            </ng-container>
                        </div>
                        <!-- Codice Richiesta -->
                        <div class="clearfix" style="width: 15%">
                            <div class="h6 mb-1 nowrap">
                                <i class="guida fas fa-hashtag fa-fw mr-1 "
                                   ngbTooltip="Identificativo richiesta" placement="top-left"></i>
                                <a class="h6">
                                    <span *ngIf="richiesta.codiceRichiesta"
                                          class="font-xxlarge">{{ richiesta.codiceRichiesta.slice(0, -5)}}
                                        <span style="font-size: 30px; font-weight: 700">{{ richiesta.codiceRichiesta.slice(richiesta.codiceRichiesta.length - 5)}}</span>
                                    </span>
                                    <span *ngIf="!richiesta.codiceRichiesta"
                                          class="font-xxlarge">{{ richiesta.codice.slice(0, -5) }}
                                        <span style="font-size: 30px; font-weight: 700">{{ richiesta.codice.slice(richiesta.codice.length - 5)}}</span>
                                    </span>
                                </a>
                            </div>
                        </div>
                        <!-- Campana Chiamata Urgente -->
                        <div class="clearfix text-center align-self-center" style="width: 7%">
                            <button *ngIf="richiesta.chiamataUrgente && richiesta.stato === 'Chiamata'"
                                    class="btn border btn-no-hover pl-0 py-0 btn-glow"
                                    ngbTooltip="Chiamata Urgente!"
                                    style="height: 36px; width: 36px; border-radius: 65% ">
                                <i class="fas fa-bell fa-fw" style="padding-left: 7px; color: #ffc107"></i>
                            </button>
                            <button *ngIf="richiesta?.dettaglioTipologia?.pos?.length"
                                    class="btn btn-light border big_font py-0 mx-1 float-right"
                                    style="margin: 0; width: 45px"
                                    ngbTooltip="Visualizza POS"
                                    (click)="onDettaglioPos(); $event.stopPropagation()">
                                <i class="fas fa-folder-open"></i>
                            </button>
                        </div>
                        <!-- Tipologia/Descrizione Chiamata/Intervento -->
                        <div style="width: 33%">
                            <div class="mb-1 nowrap default-cursor font-xxlarge">
                                <app-tipologia-sintesi-richiesta [tipologia]="richiesta?.tipologie[0]"
                                                                 [dettaglioTipologia]="richiesta?.dettaglioTipologia">
                                </app-tipologia-sintesi-richiesta>
                            </div>
                        </div>
                        <div class="clearfix" style="width: 14%"></div>
                        <div class="clearfix text-right" style="width: 26%">
                            <div class="h6 mb-0">
                                <!-- stato fonogramma -->
                                <button *ngIf="richiesta?.fonogramma"
                                        class="btn btn-light border big_font py-0 mr-1"
                                        [ngClass]="{'btn-success text-light': richiesta?.fonogramma?.stato === StatoFonogramma.Inviato, 'btn-secondary text-light': richiesta?.fonogramma?.stato === StatoFonogramma.NonNecessario, 'btn-warning text-light': richiesta?.fonogramma?.stato === StatoFonogramma.DaInviare}"
                                        style="margin: 0; vertical-align: bottom"
                                        ngbTooltip="Visualizza Fonogramma"
                                        (click)="onDettaglioStatoFonogramma(); $event.stopPropagation()">
                                    <i class="guida far fa-paper-plane fa-fw"></i>
                                    {{ getStatoFonogrammaStringByEnum(richiesta?.fonogramma?.stato) }}
                                </button>

                                <!-- enti intervenuti -->
                                <span *ngIf="methods._entiCount(methods._getEntiByCod(listaEnti, richiesta?.codEntiIntervenuti)?.length, richiesta?.listaEntiPresaInCarico?.length) as totaleEnti;">
                                    <button class="btn btn-light border big_font py-0 mr-1"
                                            ngbTooltip="Elenco Enti"
                                            (click)="onListaEnti(); $event.stopPropagation()">
                                    <i class="guida fas fa-industry fa-fw"></i>
                                        {{ totaleEnti }}
                                  </button>
                                </span>

                                <!-- dettaglio soccorso aereo -->
                                <span *ngIf="checkDettaglioSoccorsoAereo()" class="nowrap">
                                    <button class="btn btn-info pl-0 py-0 mr-1"
                                            (click)="openDettaglioSoccorsoAereoModal($event)">
                                        <i class="fas fa-helicopter fa-fw ml-2 pl-1" style="color: #f8f9fa"
                                           ngbTooltip="Dettaglio Soccorso Aereo"></i>
                                    </button>
                                </span>

                                <!-- squadre -->
                                <span class="nowrap">
                                    <ng-container *ngIf="methods.getSquadre(richiesta) as squadre">
                                        <button class="btn btn-light border pl-0 py-0 big_numbers mr-1"
                                                [ngbPopover]="popSquadre"
                                                container="body"
                                                triggers="click"
                                                tabindex="0"
                                                placement="bottom-right"
                                                (click)="$event.stopPropagation()">
                                            <i class="guida fas fa-users fa-fw ml-2 mr-1"
                                               ngbTooltip="Numero Squadre"></i>
                                            <span>{{ squadre?.length }}</span>
                                        </button>
                                        <ng-template #popSquadre>
                                            <div [class.text-light]="nightMode">
                                                <h5 class="font-weight-bolder">
                                                    Squadre
                                                </h5>
                                                <div *ngFor="let s of squadre; let i = index">
                                                    <h6 [class.mb-0]="(i + 1) === squadre.length">
                                                        <!-- Stato -->
                                                        <div class="d-inline-block mr-2">
                                                            <app-icona-stato [stato]="_nomeStatiSquadra(s.stato)">
                                                            </app-icona-stato>
                                                        </div>
                                                        <div class="d-inline-block font-weight-bold"
                                                             [ngbTooltip]="s?.codice?.length <= 7 ? labelSquadra : labelSquadraCodice">
                                                            {{ s.codice | truncate: 7 }}
                                                        </div>
                                                        <ng-template #labelSquadra>
                                                            <div>
                                                                {{ 'Nome: ' + s?.nome }}
                                                            </div>
                                                            <div>
                                                                {{ 'Sede: ' + s?.distaccamento.descrizione }}
                                                            </div>
                                                        </ng-template>
                                                        <ng-template #labelSquadraCodice>
                                                            <div>
                                                                {{ 'Codice: ' + s?.codice }}
                                                            </div>
                                                            <div>
                                                                {{ 'Nome: ' + s?.nome }}
                                                            </div>
                                                            <div>
                                                                {{ 'Sede: ' + s?.distaccamento.descrizione }}
                                                            </div>
                                                        </ng-template>
                                                        ({{ s.turno }})
                                                    </h6>
                                                </div>
                                                <ng-container *ngIf="!squadre?.length">
                                                    <h6 class="mb-0">Nessuna Squadra</h6>
                                                </ng-container>
                                            </div>
                                        </ng-template>
                                    </ng-container>
                                </span>

                                <!-- mezzi -->
                                <span class="nowrap">
                                    <button class="btn btn-light border pl-0 py-0 big_numbers mr-1"
                                            [ngbPopover]="popMezzi"
                                            triggers="click"
                                            tabindex="0"
                                            placement="bottom-right"
                                            (click)="$event.stopPropagation()">
                                        <i class="guida fas fa-truck fa-fw ml-2 mr-1" ngbTooltip="Numero Mezzi"></i>
                                        <span>{{ methods.numeroMezzi(richiesta) }}</span>
                                        <span *ngIf="methods.numeroMezziInRientro(richiesta) > 0">:{{ methods.numeroMezziInRientro(richiesta) }}
                                            r</span>
                                    </button>

                                    <ng-template #popMezzi>
                                        <div [class.text-light]="nightMode">
                                            <h5 class="font-weight-bolder">
                                                Mezzi
                                            </h5>
                                            <div *ngFor="let m of methods.mezziRichiesta(richiesta); let i = index">
                                                <h6 [class.mb-0]="(i + 1) === methods.mezziRichiesta(richiesta)?.length">
                                                    <!-- Stato -->
                                                    <div class="d-inline-block mr-2">
                                                        <app-icona-stato [stato]="m.stato"></app-icona-stato>
                                                    </div>
                                                    <!-- Sigla/Descrizione -->
                                                    <div class="d-inline-block font-weight-bold mr-2"
                                                         [ngbTooltip]="m.sigla?.length <= 6 ? labelMezzo : labelMezzoSigla"
                                                         [disableTooltip]="!m.sigla && !m.modello && m.descrizione?.length <= 6"
                                                         placement="top">
                                                        <ng-container *ngIf="m.sigla">
                                                            {{ m.sigla | truncate: 6 }}
                                                        </ng-container>
                                                        <ng-container *ngIf="!m.sigla && m.descrizione">
                                                            {{ m.descrizione | truncate: 6 }}
                                                        </ng-container>
                                                    </div>
                                                    <ng-template #labelMezzo>
                                                        <div>
                                                            {{ 'Targa: ' + m.descrizione }}
                                                        </div>
                                                        <div>
                                                            {{ 'Modello: ' + m.modello }}
                                                        </div>
                                                        <div>
                                                            {{ 'Sede: ' + m.distaccamento.descrizione }}
                                                        </div>
                                                    </ng-template>
                                                    <ng-template #labelMezzoSigla>
                                                        <div>
                                                            {{ 'Sigla: ' + m.sigla }}
                                                        </div>
                                                        <div>
                                                            {{ 'Targa: ' + m.descrizione }}
                                                        </div>
                                                        <div>
                                                            {{ 'Modello: ' + m.modello }}
                                                        </div>
                                                        <div>
                                                            {{ 'Sede: ' + m.distaccamento.descrizione }}
                                                        </div>
                                                    </ng-template>
                                                    <!-- Genere -->
                                                    <div class="d-inline-block"
                                                         [ngbTooltip]="m.genere"
                                                         [disableTooltip]="m.genere?.length <= 4">
                                                        {{ m.genere | truncate: 4 }}
                                                    </div>
                                                </h6>
                                            </div>
                                            <ng-container
                                                    *ngIf="methods.numeroMezzi(richiesta) === 0 && methods.numeroMezziInRientro(richiesta) === 0">
                                                <h6 class="mb-0">Nessun Mezzo</h6>
                                            </ng-container>
                                        </div>
                                    </ng-template>
                                </span>

                                <button *ngIf="!fissata && fissabile"
                                        class="btn btn-light border py-0 px-0"
                                        style="width: 45px"
                                        ngbTooltip="Fissa in alto"
                                        [disabled]="disableFissaInAlto"
                                        (click)="fissaClick(richiesta); $event.stopPropagation()">
                                    <i class="fas fa-fw fa-thumbtack fa-rotate-45 text-secondary"></i>
                                </button>

                                <ng-container *ngIf="fissata && fissabile">
                                    <button class="btn btn-primary py-0 px-0"
                                            style="width: 45px"
                                            ngbTooltip="Inserisci nella lista"
                                            (click)="fissaClick(richiesta); $event.stopPropagation()">
                                        <i class="fas fa-fw fa-thumbtack fa-rotate-45"></i>
                                    </button>
                                </ng-container>
                            </div>
                        </div>
                    </div>

                    <!-- SECONDA RIGA -->
                    <div class="row">
                        <div class="clearfix ml-4" style="width: 2%">
                        </div>
                        <div class="clearfix" style="width: 12%; align-self: center">
                            <div class="h6 mt-1 mb-2 nowrap default-cursor">
                                <i class="guida far fa-clock fa-fw mr-1 "
                                   ngbTooltip="Ricezione richiesta"
                                   placement="bottom-left" container="body"></i>
                                <a ngbTooltip="{{ (richiesta.istanteRicezioneRichiesta | friendlyDateTooltip) || '' }}">
                                    <span timeago class="font-xxlarge"
                                          [date]="methods._dateNumber(richiesta.istanteRicezioneRichiesta)"
                                          [live]="live">
                                    </span>
                                </a>
                            </div>
                        </div>
                        <div class="clearfix" style="width: 10%"></div>
                        <div class="clearfix"
                             style="width: 33%">
                            <span (click)="indirizzoClick(richiesta)" style="cursor: pointer">
                                <i class="guida fas fa-map-marker-alt fa-fw mr-1" style="font-size: 140%"
                                   ngbTooltip="Località"></i>
                                <ng-container
                                        *ngIf="!richiesta?.localita?.indirizzo && richiesta?.localita?.coordinate">
                                    <span ngbTooltip="{{ richiesta.localita.indirizzo }}"
                                          class="font-xxlarge">
                                          Lat: {{ richiesta.localita.coordinate?.latitudine }} -
                                          Lon: {{ richiesta.localita.coordinate?.longitudine }}
                                  </span>
                                </ng-container>
                                <ng-container *ngIf="richiesta?.localita?.indirizzo">
                                    <div class="d-inline-block font-xxlarge"
                                         [ngbTooltip]="getIndirizzoFormatted()"
                                         [disableTooltip]="getIndirizzoFormatted()?.length <= 20">
                                      {{ getIndirizzoFormatted() | truncate:20 }}
                                    </div>
                                </ng-container>
                            <span *ngIf="!partenza"
                                  class="list-inline list-unstyled m-0 ml-2 font-xxlarge"
                                  style="vertical-align: text-bottom;">
                                <app-competenza *ngFor="let c of richiesta?.competenze; let i = index"
                                                [competenza]="c" [i]="i"></app-competenza>
                        </span>
                            </span>
                        </div>
                        <div class="clearfix"
                             style="width: 26%; align-self: center">
                            <!-- richiedente -->
                            <div class="h6 mt-1 mb-2 nowrap default-cursor">
                                <i class="guida far fa-address-book fa-fw mr-1"
                                   style="font-size: 140%"
                                   ngbTooltip="Richiedente"
                                   container="body"></i>
                                <span *ngIf="richiesta?.richiedente?.nominativo" class="font-xxlarge mr-2">
                                    <a ngbTooltip="{{ richiesta?.richiedente?.nominativo }}"
                                       placement="top"
                                       [disableTooltip]="richiesta?.richiedente?.nominativo?.length <= 20">
                                        {{ richiesta?.richiedente?.nominativo | truncate:20 }}
                                    </a>
                                </span>
                                <span class="ml-1">
                                    <i class="guida fas fa-phone-alt fa-fw mr-1"
                                       style="font-size: 145%"
                                       ngbTooltip="Numero richiedente"></i>
                                    <a class="font-xxlarge">
                                        {{ richiesta?.richiedente?.telefono }}
                                    </a>
                                </span>
                            </div>
                        </div>
                        <div class="clearfix text-right"
                             style="width: 14%">
                            <div class="h6 m-0 nowrap mt-1">
                                <ng-container *ngIf="boxAzioni">
                                    <button class="btn btn-light border py-0 px-0 mr-1"
                                            [ngbTooltip]="'Visualizza azioni per ' + defineChiamataIntervento(this.richiesta.codice, this.richiesta?.codiceRichiesta) + ' : ' + richiesta.codice"
                                            [disabled]="disabledAzioniRichiesta"
                                            [class.cursor-not-allowed]="disabledAzioniRichiesta"
                                            (click)="onShowAzioniRichiesta(); $event.stopPropagation()">
                                        <i class="fas fa-fw fa-expand text-secondary"></i>
                                    </button>
                                </ng-container>
                                <ng-container *ngIf="gestibile">
                                    <button class="btn btn-light border py-0 px-0 mr-1"
                                            [class.on-gestione]="inGestione"
                                            ngbTooltip="Gestisci"
                                            (click)="onGestioneRichiesta($event)">
                                        <i class="fas fa-fw "
                                           [ngClass]="methods.toggleGestioneClass(inGestione)"></i>
                                    </button>
                                </ng-container>
                                <ng-container *ngIf="modificabile">
                                    <div class="d-inline-block"
                                         [ngbTooltip]="tooltipModificaLockedConcorrenza"
                                         [disableTooltip]="!(tipoConcorrenzaEnum.Modifica | checkConcorrenzaLocked: [this.richiesta.codice])"
                                         placement="left">
                                        <button class="btn btn-light border py-0 px-0 mr-1"
                                                ngbTooltip="Modifica"
                                                [disabled]="disabledModificaRichiesta"
                                                [class.cursor-not-allowed]="disabledModificaRichiesta"
                                                (click)="onModificaRichiesta(); $event.stopPropagation()">
                                            <i class="far fa-fw fa-edit text-secondary"></i>
                                        </button>
                                    </div>
                                </ng-container>
                                <div class="d-inline-block"
                                     [ngbTooltip]="tooltipInvioPartenzaLockedConcorrenza"
                                     [disableTooltip]="!(tipoConcorrenzaEnum.InvioPartenza | checkConcorrenzaLocked: [this.richiesta.codice])"
                                     placement="left">
                                    <button *ngIf="!partenza && composizionePartenza"
                                            class="btn btn-light border py-0 px-2"
                                            ngbTooltip="Invio partenza"
                                            [disabled]="disabledComposizionePartenza"
                                            [class.cursor-not-allowed]="disabledComposizionePartenza"
                                            (click)="invioPartenza(richiesta); $event.stopPropagation()">
                                        <i class="fas fa-fw fa-arrow-right text-secondary"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- II livello di dettaglio -->
                    <ng-container *ngIf="inGestione">
                        <div class="col-12 default-cursor"
                             [class.d-none]="partenza">
                            <div class="row mt-2">
                                <!-- I colonna -->
                                <div class="col-2">
                                    <div class="clearfix">
                                        <!-- Operatore chiamata -->
                                        <ng-container *ngIf="richiesta?.operatore as op">
                                            <h4 class="mb-0"
                                                [ngbTooltip]="operatoreRegistrazioneChiamata"
                                                placement="top">
                                                <i class="guida fas fa-user fa-fw"></i>
                                                <i class="guida fas fa-phone-alt fa-fw mr-1"></i>
                                                {{ op?.nome + ' ' + op?.cognome | truncate: 11 }}
                                                <ng-template #operatoreRegistrazioneChiamata>
                                                    <div>
                                                        {{ op?.nome + ' ' + op?.cognome }} ha registrato la chiamata
                                                    </div>
                                                </ng-template>
                                            </h4>
                                        </ng-container>

                                        <!-- Presa in carico -->
                                        <ng-container *ngIf="methods._primoUtente(richiesta?.listaUtentiPresaInCarico)">
                                            <ng-container
                                                    *ngIf="methods._primoUtente(richiesta?.listaUtentiPresaInCarico) as utentiPresaInCaricoValue; else nonPresaInCarico">
                                                <h4 class="d-inline-block m-0 mr-1"
                                                    [ngbTooltip]="utentePresaInCarico">
                                                    <i class="guida far fa-calendar-check fa-fw mr-1"></i>
                                                    {{ utentiPresaInCaricoValue?.nominativo | truncate: (richiesta?.listaUtentiPresaInCarico?.length > 1 ? 9 : 13) }}
                                                    <ng-template #utentePresaInCarico>
                                                        <div>
                                                            {{ utentiPresaInCaricoValue?.nominativo }} ha preso in
                                                            carico
                                                            {{ getPresaInCaricoTooltip(utentiPresaInCaricoValue)?.dataInizioAttivita | friendlyDate }}
                                                            {{ getPresaInCaricoTooltip(utentiPresaInCaricoValue)?.dataInizioAttivita | friendlyHour: true }}
                                                        </div>
                                                    </ng-template>
                                                </h4>
                                            </ng-container>
                                            <ng-container
                                                    *ngIf="richiesta?.listaUtentiPresaInCarico && richiesta?.listaUtentiPresaInCarico?.length > 1">
                                                <div ngbDropdown class="d-inline-block" placement="bottom">
                                                    <button ngbDropdownToggle class="btn btn-light border py-0 px-1"
                                                            (click)="$event.stopPropagation()">
                                                        +{{ richiesta?.listaUtentiPresaInCarico?.length - 1 }}
                                                    </button>
                                                    <div ngbDropdownMenu class="p-2 text-center">
                                                        <div *ngIf="methods._altriUtenti(richiesta?.listaUtentiPresaInCarico) as utentiTooltip">
                                                            <div *ngFor="let utente of utentiTooltip">
                                                                {{utente?.nominativo}}
                                                                - {{utente?.dataInizioAttivita | friendlyDate}}
                                                                {{utente?.dataInizioAttivita | friendlyHour: true}}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                            <ng-template #nonPresaInCarico>
                                                <h4>Nhon Presa in Carico</h4>
                                            </ng-template>
                                        </ng-container>

                                        <!-- Scheda NUE -->
                                        <ng-container *ngIf="richiesta?.codiceSchedaNue">
                                            <ng-container *ngIf="richiesta?.codiceSchedaNue; else nessunCodiceNue">
                                                <h4 class="d-inline-block">
                                                    <i class="guida far fa-id-card fa-fw mr-1"
                                                       ngbTooltip="Codice scheda NUE"
                                                       placement="right">
                                                    </i>
                                                    S. NUE
                                                    <div class="d-inline-block font-weight-bold mr-1 cursor-pointer"
                                                         [class.cursor-pointer]="loadingDettaglioSchedaContatto && loadingDettaglioSchedaContatto === richiesta?.codiceSchedaNue"
                                                         [class.cursor-loading]="loadingDettaglioSchedaContatto && loadingDettaglioSchedaContatto === richiesta?.codiceSchedaNue"
                                                         [class.opacity-50]="loadingDettaglioSchedaContatto && loadingDettaglioSchedaContatto === richiesta?.codiceSchedaNue"
                                                         (click)="onDettaglioSchedaContatto(richiesta?.codiceSchedaNue)">
                                                        {{ richiesta?.codiceSchedaNue }}
                                                    </div>

                                                    <!-- Note Nue -->
                                                    <i *ngIf="richiesta?.noteNue" class="fa-fw fas fa-sticky-note guida"
                                                       [ngbTooltip]="richiesta.noteNue"
                                                       placement="right">
                                                    </i>
                                                </h4>
                                            </ng-container>
                                            <ng-template #nessunCodiceNue>
                                                <h4>Nessuna scheda NUE</h4>
                                            </ng-template>
                                        </ng-container>

                                        <!-- Sedi allertate -->
                                        <ng-container *ngIf="methods._primaSedeAllertata(richiesta?.sediAllertate)">
                                            <ng-container
                                                    *ngIf="methods._primaSedeAllertata(richiesta?.sediAllertate) as sediAllertate; else nonAllertata">
                                                <h4 class="d-inline-block m-0 mr-1"
                                                    ngbTooltip="{{ sediAllertate }}"
                                                    [disableTooltip]="richiesta?.codSOAllertate?.length > 1 ? sediAllertate?.length <= 9 : sediAllertate?.length <= 13"
                                                    placement="bottom">
                                                    <i class="guida fas fa-exclamation-triangle fa-fw mr-1"
                                                       ngbTooltip="Sedi Allertate"
                                                       placement="right"></i>
                                                    {{ sediAllertate | truncate: (richiesta?.codSOAllertate?.length > 1 ? 9 : 13) }}
                                                </h4>
                                            </ng-container>
                                            <ng-container
                                                    *ngIf="richiesta?.codSOAllertate && richiesta?.codSOAllertate?.length > 1">
                                                <div ngbDropdown class="d-inline-block" placement="bottom">
                                                    <button ngbDropdownToggle class="btn btn-light border py-0 px-1"
                                                            (click)="$event.stopPropagation()">
                                                        +{{ richiesta?.codSOAllertate?.length - 1 }}
                                                    </button>
                                                    <div ngbDropdownMenu class="p-2 text-center">
                                                        <ng-container
                                                                *ngIf="methods._altreSediAllertate(richiesta?.sediAllertate) as codSOAllertate">
                                                            <div *ngFor="let sede of codSOAllertate">
                                                                {{ sede }}
                                                            </div>
                                                        </ng-container>
                                                    </div>
                                                </div>
                                            </ng-container>
                                            <ng-template #nonAllertata class="badge badge-secondary text-white">
                                                <!-- Nessuna Sede Allertata -->
                                            </ng-template>
                                        </ng-container>
                                    </div>
                                </div>
                                <!-- II colonna Triage -->
                                <ng-container *ngIf="checkNumeroPartenzeAttive(richiesta.partenze) <= 0">
                                    <div class="col-8">
                                        <ng-container *ngIf="richiesta?.triageSummary?.length">
                                            <div style="max-height: 170px;overflow-y: auto;">
                                                <app-triage-summary-sintesi-richiesta
                                                        [triageSummary]="richiesta?.triageSummary"
                                                        [pos]="richiesta?.dettaglioTipologia?.pos">
                                                </app-triage-summary-sintesi-richiesta>
                                            </div>
                                        </ng-container>
                                    </div>
                                </ng-container>
                                <!-- II colonna Lista Partenze -->
                                <ng-container *ngIf="checkNumeroPartenzeAttive(richiesta.partenze) > 0">
                                    <div class="col-8 px-0 border border-lista-partenze"
                                         style="height: fit-content">
                                        <div class="scroll-y max-height-richiesta">
                                            <app-lista-partenze [richiesta]="richiesta"
                                                                [inGestione]="inGestione"
                                                                [idDaSganciare]="idDaSganciare"
                                                                [sostituzioneFineTurnoActive]="_isSostituzioneFineTurnoActive(richiesta?.partenze)"
                                                                [loadingActionMezzo]="loadingActionMezzo"
                                                                [annullaStatoMezzi]="annullaStatoMezzi"
                                                                [disabledModificaStatoMezzo]="disabledModificaStatoMezzo"
                                                                [hideSostituzioneFineTurno]="hideSostituzioneFineTurno"
                                                                [hideGestisciPartenza]="hideGestisciPartenza"
                                                                [dateSync]="dateSync"
                                                                (actionMezzo)="onActionMezzo($event)"
                                                                (modificaPartenza)="onModificaPartenza($event)"
                                                                (sostituzioneFineTurno)="onSostituzioneFineTurno(richiesta.partenze)"
                                                                (selezioneMezzo)="onSelezioneMezzoPartenza($event)">
                                            </app-lista-partenze>
                                        </div>
                                    </div>
                                </ng-container>
                                <!-- III colonna -->
                                <div class="col-2">
                                    <div class="clearfix">
                                        <!-- turno intervento -->
                                        <div class="text-right">
                                            <ng-container *ngIf="richiesta?.trnInsChiamata; else nessunTurno">
                                                <h4 class="mb-0">
                                                    {{ richiesta?.trnInsChiamata }}
                                                    <i class="fa-fw far fa-calendar-check guida ml-1"
                                                       ngbTooltip="Turno Inserimento"
                                                       placement="left">
                                                    </i>
                                                </h4>
                                            </ng-container>
                                            <ng-template #nessunTurno>
                                                <h4>
                                                    <span class="d-inline-block mr-1">-</span>
                                                    <i class="guida far fa-clock fa-fw ml-1"
                                                       ngbTooltip="Turno non presente"
                                                       placement="left"></i>
                                                </h4>
                                            </ng-template>
                                        </div>

                                        <!-- tipo terreno -->
                                        <ng-container *ngIf="richiesta?.tipoTerreno?.length">
                                            <div class="text-right">
                                                <div *ngIf="methods._terrenoMaggiore(richiesta?.tipoTerreno) as tipoTerrenoValue; else noterreni"
                                                     class="d-inline-block mr-2"
                                                     [ngbTooltip]="tipoTerrenoValue?.terrenoMq">
                                                    {{ tipoTerrenoValue?.terrenoHa }}
                                                </div>
                                                <button *ngIf="richiesta?.tipoTerreno && richiesta?.tipoTerreno.length > 1"
                                                        class="btn btn-light px-1 py-0" [ngbPopover]="terreni"
                                                        placement="left"
                                                        (click)="$event.stopPropagation()">
                                                    +{{ richiesta?.tipoTerreno?.length - 1 }}</button>
                                                <ng-template #terreni>
                                                    <div *ngIf="methods._terreniMinori(richiesta?.tipoTerreno) as terreniTooltip">
                                                        <div *ngFor="let terreno of terreniTooltip" class="h6 mb-0">
                                                            {{ methods._tipoTerreno(terreno)}}
                                                        </div>
                                                    </div>
                                                </ng-template>
                                                <ng-template #noterreni>
                                                    -
                                                </ng-template>
                                                <i class="guida fas fa-tree fa-fw ml-1" ngbTooltip="Tipologia terreno"
                                                   placement="left"></i>
                                            </div>
                                        </ng-container>

                                        <!-- complessità -->
                                        <ng-template [ngIf]="richiesta?.complessita?.indice !== '0'">
                                            <div class="text-right">
                                                <h4>
                                                    <b>{{ richiesta?.complessita?.indice }}</b>
                                                    <span class="badge m-0 ml-1"
                                                          [ngClass]="complessitaClass(richiesta)">
                                                    {{ richiesta?.complessita?.descrizione }}
                                                </span>
                                                    <i class="guida fas fa-cogs fa-fw ml-1" ngbTooltip="Complessità"
                                                       placement="left"></i>
                                                </h4>
                                            </div>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                            <!-- box note localita e zone emergenza -->
                            <ng-container
                                    *ngIf="richiesta?.localita?.note || richiesta?.notePrivate || richiesta?.notePubbliche || richiesta?.zoneEmergenza?.length || richiesta?.tags?.length">
                                <div class="row">
                                    <div class="col-12 mt-2">
                                        <div class="card">
                                            <div class="card-body py-2">
                                                <div class="row">
                                                    <ng-container *ngIf="richiesta?.localita?.note">
                                                        <div class="col">
                                                            <div class="d-inline-block cursor-pointer"
                                                                 ngbTooltip="Note Indirizzo"
                                                                 placement="top">
                                                                <i class="fas fa-sticky-note guida mr-1"></i>
                                                                <i class="fas fa-map-marker-alt guida mr-1"></i>
                                                            </div>
                                                            <b>Note località - </b>{{ richiesta.localita.note }}
                                                        </div>
                                                    </ng-container>
                                                    <ng-container *ngIf="richiesta?.notePrivate">
                                                        <div class="col">
                                                            <div class="d-inline-block cursor-pointer"
                                                                 ngbTooltip="Note Private"
                                                                 placement="top">
                                                                <i class="fas fa-sticky-note guida mr-1"></i>
                                                                <i class="fas fa-user-lock guida mr-1"></i>
                                                            </div>
                                                            <b>Note private - </b>{{ richiesta.notePrivate }}
                                                        </div>
                                                    </ng-container>
                                                    <ng-container *ngIf="richiesta?.notePubbliche">
                                                        <div class="col">
                                                            <div class="d-inline-block cursor-pointer"
                                                                 ngbTooltip="Note Pubbliche"
                                                                 placement="top">
                                                                <i class="fas fa-sticky-note guida mr-1"></i>
                                                            </div>
                                                            <b>Note pubbliche - </b>{{ richiesta.notePubbliche }}
                                                        </div>
                                                    </ng-container>
                                                </div>
                                                <!-- <ng-container *ngIf="richiesta?.zoneEmergenza?.length">
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div *ngFor="let ze of richiesta.zoneEmergenza"
                                                                 class="badge badge-danger m-1">
                                                                {{ ze }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-container> -->
                                                <ng-container *ngIf="richiesta?.tags?.length">
                                                    <div class="row">
                                                        <div class="mt-1 col-12">
                                                            <i class="guida fas fa-tags mr-1"
                                                               title="Etichette"></i>
                                                            <div *ngFor="let tag of richiesta?.tags"
                                                                 class="badge badge-secondary">
                                                                <i class="fas fa-hashtag fa-fw"></i>
                                                                {{ tag | uppercase }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #tooltipModificaLockedConcorrenza>
    <i class="fas fa-lock mr-1"></i>
    {{ tipoConcorrenzaEnum.Modifica | checkConcorrenzaLocked: [richiesta.codice] }}
</ng-template>

<ng-template #tooltipInvioPartenzaLockedConcorrenza>
    <i class="fas fa-lock mr-1"></i>
    {{ tipoConcorrenzaEnum.InvioPartenza | checkConcorrenzaLocked: [richiesta.codice] }}
</ng-template>
