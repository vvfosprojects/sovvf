<div class="row min-h-comp">
    <ng-container *ngIf="loadingInvioPartenza">
        <app-partial-loader></app-partial-loader>
    </ng-container>
    <div class="col-8">
        <div class="row">
            <!-- Filterbar -->
            <div class="col-12 px-0">
                <app-filterbar-composizione [filtri]="filtri"
                                            [nightMode]="nightMode"
                                            [competenze]="richiesta?.competenze"
                                            [disableComposizioneMode]="loadingMezzi || loadingSquadre"
                                            [composizionePartenza]="true"
                                            [loadingSquadre]="loadingSquadre"
                                            [loadingMezzi]="loadingMezzi"
                                            [triageSummary]="triageSummary">
                </app-filterbar-composizione>
            </div>

            <!-- Lista Squadre -->
            <div class="col-5 px-0">
                <div class="card min-h-comp">
                    <app-partial-loader *ngIf="!squadreComposizione || loadingSquadre"></app-partial-loader>
                    <div class="card-header clearfix px-2 py-1">
                        <div class="float-left h3 mb-0 pt-1 pl-2">
                            <i class="fas fa-users mr-1"></i>
                            Squadre
                        </div>
                        <div class="float-right w-50">
                            <label for="ricercaSquadre"
                                   class="d-none"></label>
                            <input id="ricercaSquadre"
                                   class="form-control"
                                   [ngClass]="{'border-danger': ricercaSquadre?.length}"
                                   type="search"
                                   name="ricercaSquadre"
                                   placeholder="Cerca..."
                                   [(ngModel)]="ricercaSquadre"
                                   appDebounceKeyUp
                                   [debounceTime]="1000"
                                   (debounceKeyUp)="onSearchSquadre()"
                                   (search)="onClearSearchSquadre()">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush min-h-comp">
                            <li *ngIf="!squadreComposizione?.length && !loadingSquadre"
                                class="px-3 pt-1" style="list-style: none;">
                                <span class="text-muted">Nessun risultato trovato.</span>
                            </li>
                            <li *ngIf="loadingSquadre"
                                class="px-3 pt-1" style="list-style: none;">
                                <span class="text-muted">Caricamento risultati...</span>
                            </li>
                            <ng-template [ngIf]="squadreComposizione?.length && !loadingSquadre">
                                <app-squadra-composizione
                                        *ngFor="let sC of squadreComposizione"
                                        [nightMode]="nightMode"
                                        [loadingMezzi]="loadingMezzi"
                                        [squadraComposizione]="sC"
                                        [boxPartenzaList]="boxPartenzaList"
                                        [itemSelezionato]="checkSquadraSelezione(sC.codice)"
                                        [itemHover]="checkSquadraHover(sC.codice)"
                                        [richiesta]="richiesta"
                                        (selezionata)="squadraSelezionata($event)"
                                        (selezionataInRientro)="squadraSelezionataInRientro($event)"
                                        (selezionataPreAccoppiati)="squadraSelezionataPreAccoppiati($event)"
                                        (deselezionata)="squadraDeselezionata($event)"
                                        (deselezionataInRientro)="squadraDeselezionataInRientro($event)"
                                        (deselezionataPreAccoppiati)="squadraDeselezionataPreAccoppiati($event)"
                                        (hoverIn)="squadraHoverIn($event)"
                                        (hoverOut)="squadraHoverOut($event)">
                                </app-squadra-composizione>
                            </ng-template>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col"
                         style="display: flex; place-content: center; margin-top: 10px;">
                        <ngb-pagination
                                [(page)]="currentPageSquadre"
                                [pageSize]="pageSizeSquadre"
                                [collectionSize]="totalItemsSquadre"
                                [maxSize]="2"
                                [disabled]="loadingSquadre"
                                (pageChange)="squadrePageChange($event)">
                        </ngb-pagination>
                    </div>
                </div>
            </div>

            <!-- Lista Mezzi -->
            <div class="col-7 pr-0">
                <div class="card mx-auto min-h-comp">
                    <app-partial-loader *ngIf="!squadreComposizione || loadingMezzi"></app-partial-loader>
                    <div class="card-header clearfix px-2 py-1">
                        <div class="float-left h3 mb-0 pt-1 pl-2">
                            <i class="fas fa-truck mr-1"></i>
                            Mezzi
                        </div>
                        <div class="float-right"
                             style="width: 35%">
                            <label for="ricercaMezzi"
                                   class="d-none"></label>
                            <input id="ricercaMezzi"
                                   class="form-control"
                                   [ngClass]="{'border-danger': ricercaMezzi?.length}"
                                   type="search"
                                   name="ricercaMezzi"
                                   placeholder="Cerca..."
                                   [(ngModel)]="ricercaMezzi"
                                   appDebounceKeyUp
                                   [debounceTime]="1000"
                                   (debounceKeyUp)="onSearchMezzi()"
                                   (search)="onClearSearchMezzi()">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush min-h-comp">
                            <li *ngIf="!mezziComposizione?.length && !loadingMezzi"
                                class="px-3 pt-1" style="list-style: none;">
                                <span class="text-muted">Nessun risultato trovato.</span>
                            </li>
                            <li *ngIf="loadingMezzi"
                                class="px-3 pt-1" style="list-style: none;">
                                <span class="text-muted">Caricamento risultati...</span>
                            </li>
                            <ng-template [ngIf]="mezziComposizione?.length && !loadingMezzi">
                                <div *ngFor="let mC of mezziComposizione">
                                    <ng-template [ngIf]="mC.mezzo.stato !== statoMezzo.OperativoPreaccoppiato">
                                        <app-mezzo-composizione [mezzoComp]="mC"
                                                                [nightMode]="nightMode"
                                                                [loadingSquadre]="loadingSquadre"
                                                                [boxPartenzaList]="boxPartenzaList"
                                                                [itemSelezionato]="checkMezzoSelezione(mC.id)"
                                                                [itemHover]="checkMezzoHover(mC.id)"
                                                                [itemInPrenotazione]="idMezziInPrenotazione ? idMezziInPrenotazione.indexOf(mC.id) !== -1 : false"
                                                                [itemPrenotato]="idMezziPrenotati ? idMezziPrenotati.indexOf(mC.id) !== -1 : false"
                                                                [itemBloccato]="idMezziBloccati ? idMezziBloccati.indexOf(mC.id) !== -1 : false"
                                                                [richiesta]="richiesta"
                                                                (selezionato)="mezzoSelezionato($event)"
                                                                (selezionatoInRientro)="mezzoSelezionatoInRientro($event)"
                                                                (selezionatoPreAccoppiati)="mezzoSelezionatoPreAccoppiati($event)"
                                                                (deselezionato)="mezzoDeselezionato($event)"
                                                                (deselezionatoInRientro)="mezzoDeselezionatoInRientro($event)"
                                                                (deselezionatoPreAccoppiati)="mezzoDeselezionatoPreAccoppiati($event)"
                                                                (hoverIn)="mezzoHoverIn($event)"
                                                                (hoverOut)="mezzoHoverOut()"
                                                                (mezzoCoordinate)="mezzoCoordinate($event)"
                                                                (mezzoCoordinateClear)="mezzoCoordinateClear()"
                                                                (sganciamento)="sganciamento.emit($event)">
                                        </app-mezzo-composizione>
                                    </ng-template>
                                </div>
                            </ng-template>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col"
                         style="display: flex; place-content: center; margin-top: 10px;">
                        <ngb-pagination
                                [(page)]="currentPageMezzi"
                                [pageSize]="pageSizeMezzi"
                                [collectionSize]="totalItemsMezzi"
                                [maxSize]="5"
                                [disabled]="loadingMezzi"
                                (pageChange)="mezziPageChange($event)">
                        </ngb-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-4 pr-0">
        <!-- Lista Partenze Richiesta Composizione -->
        <div style="height:50%">
            <app-lista-partenze-composizione [richiesta]="richiesta"
                                             [visualizzaPercorsi]="visualizzaPercorsiRichiesta"
                                             [nightMode]="nightMode"
                                             (toggleVisualizzaPercorsi)="onToggleVisualizzaPercorsi($event)">
            </app-lista-partenze-composizione>
        </div>

        <!-- Box Partenza -->
        <div class="w-100 py-2 px-1" style="height:40%">
            <!-- bottone nuova partenza -->
            <div *ngIf="boxPartenzaList?.length <= 1" class="text-center mb-2">
                <button class="btn btn-primary btn-no-hover"
                        style="width: 50%"
                        (click)="nuovaPartenza()"
                        [disabled]="disableNuovaPartenza || boxPartenzaList.length > 1"><i
                        class="fas fa-plus mr-2"></i><span>Aggiungi Altra Partenza</span>
                </button>
            </div>
            <!-- lista box partenze -->
            <div *ngIf="boxPartenzaList?.length">
                <div *ngFor="let p of boxPartenzaList.slice().reverse(); let index = index">
                    <app-box-nuova-partenza [partenza]="p" [richiesta]="richiesta" [elimina]="true"
                                            [nightMode]="nightMode"
                                            [loadingSquadre]="loadingSquadre"
                                            [loadingMezzi]="loadingMezzi"
                                            [disableDividi]="checkDoubleDividi(p)"
                                            [itemSelezionato]="p.id === idBoxPartenzaSelezionato"
                                            [compPartenzaMode]="Composizione.Avanzata"
                                            [alert]="true"
                                            (eliminato)="eliminaBoxPartenza($event)"
                                            (squadraShortcut)="squadraShortcut($event)">
                    </app-box-nuova-partenza>
                </div>
            </div>
        </div>

        <!-- Soccorso aereo triage-->
        <div class="clearfix">
            <div class="float-left w-100 pl-2" style="width: 2%">
                <div class="clearfix d-flex" style="padding-left: 32%">
                    <div class="float-left">
                        <ngb-rating [rate]="getSoccorsoAereoTriage(triageSummary)?.value"
                                    [max]="4"
                                    [readonly]="true">
                            <ng-template let-fill="fill" let-index="index">
                                <div class="circle d-inline-block font-double-monitor"
                                     [class.filled]="fill === 100"
                                     [class.bad]="index > 2 && fill === 100">
                                    <i class="fas fa-circle mr-1"></i>
                                </div>
                            </ng-template>
                        </ngb-rating>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottoni Composizione -->
        <app-composizione-confirm-button [boxPartenzaLenght]="boxPartenzaList.length"
                                         [richiesta]="richiesta"
                                         [disableConfirmPartenza]="disableConfirmPartenza"
                                         (confirmPartenzaInViaggio)="confermaPartenzeInViaggio()">
        </app-composizione-confirm-button>
    </div>
</div>
